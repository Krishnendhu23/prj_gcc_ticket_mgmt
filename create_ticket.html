<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Create Ticket | Ticket Management Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="assets/adminlte/plugins/fontawesome-free/css/all.min.css" />
    <link rel="stylesheet" href="assets/adminlte/plugins/icheck-bootstrap/icheck-bootstrap.min.css" />
    <link rel="stylesheet" href="assets/adminlte/css/adminlte.min.css" />
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="assets/adminlte/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css">

</head>

<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">

        <!-- header section start -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <div class="nav-link">Logged in as Demo User</div>
                </li>
                <li class="nav-item">
                    <button type="button" class="btn btn-sm btn-danger"
                        onclick="window.location.href='index.html'">Logout</button>
                </li>
            </ul>
        </nav>
        <!-- header section end -->

        <!-- menu section start -->
        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <a href="dashboard.html " class="brand-link text-center">
                <i class="fas fa-user fa-2x"></i>
                <span class="brand-text font-weight-light">Demo User</span>
            </a>

            <div class="sidebar">
                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" role="menu">
                        <li class="nav-item">
                            <a href="dashboard.html" class="nav-link">
                                <i class="nav-icon fas fa-tachometer-alt"></i>
                                <p>Dashboard</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="create_ticket.html" class="nav-link">
                                <i class="nav-icon fas fa-clipboard-list"></i>
                                <p>Create Ticket</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="ticket_approvals.html" class="nav-link">
                                <i class="nav-icon fas fa-calendar-alt"></i>
                                <p>Ticket Approvals</p>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>
        <!-- menu section end -->

        <div class="content-wrapper">
            <section class="content pt-3 px-3">

                <div class="container">
                    <h2>All Tickets</h2>

                    <div class="d-flex justify-content-end mb-3">
                        <input type="button" class="btn btn-success" data-toggle="modal"
                            data-target="#createTicketModal" value="Create New Ticket" />
                    </div>


                    <!-- listing all tickets in a table -->
                    <table class="table table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>

                </div>

            </section>
        </div>

        <!-- Modal form for creating new request start-->
        <div class="modal fade" id="createTicketModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog " role="document">
                <div class="modal-content">

                    <div class="modal-header">
                        <h5 class="modal-title">Create Ticket</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>

                    <form method="POST" id="frmCreateTicket" name="frmCreateTicket">
                        <div class="modal-body">

                            <div class="form-group col-md-12">
                                <label>Title</label>
                                <input type="text" class="form-control" name="title" required />
                            </div>

                            <div class="form-group col-md-12">
                                <label>Amount</label>
                                <input type="number" class="form-control" name="amount" required min="1" />
                            </div>

                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Create Ticket</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Back to Tickets
                                List</button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
        <!-- Modal form for creating new request end-->


        <!-- modal for ticket status journey view start -->
        <div class="modal fade" id="ticketStatusViewModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">

                    <div class="modal-header">
                        <h5 class="modal-title">Ticket Journey View</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>

                    <div class="modal-body">
                    </div>
                </div>
            </div>
        </div>
        <!-- modal for ticket status journey view end -->



        <footer class="main-footer text-center">
            <strong>Ticket Management System</strong> &copy; 2026
        </footer>
    </div>

    <!-- Scripts -->
    <script src="assets/adminlte/plugins/jquery/jquery.min.js"></script>
    <script src="assets/adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/adminlte/js/adminlte.min.js"></script>

    <!-- validation -->
    <script src="assets/adminlte/plugins/jquery-validation/jquery.validate.min.js"></script>
    <script src="assets/adminlte/plugins/jquery-validation/additional-methods.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="assets/adminlte/plugins/sweetalert2/sweetalert2.min.js"></script>

    <!-- sample data script -->
    <script src="demo-data/tickets.js"></script>

    <script>

        /*
        * When document is ready
        */
        $(document).ready(function () {

            //call the data listing function
            getAllTickets();
        });

        //function to get all tickets
        function getAllTickets() {

            let tbody = $("table tbody");
            tbody.empty();

            tickets.forEach(ticket => {

                let displayStatus = ticket.status == 'Pending' ? ticket.status + '<br><small>' + ticket.level + '</small>' : ticket.status;
                let row = `<tr>
                    <td>${ticket.id}</td>
                    <td>${ticket.title}</td>
                    <td>${ticket.amount}</td>
                    <td><span class="badge badge-${ticket.status === 'Approved' ? 'success' : ticket.status === 'Rejected' ? 'danger' : 'warning'}">${displayStatus}</span></td> // status badge with color
                    <td>
                        <button class="btn btn-info btn-sm" onclick="getStatusJourney(${ticket.id})">View</button>
                    </td>
                </tr>`;
                tbody.append(row);
            });
        }

        //function for ticket status journey  view
        function getStatusJourney(ticket_id) {

            let ticket = tickets.find(t => t.id === ticket_id);

            let managerStatus = ticket.status_timeline.find(a => a.level === 'Manager');
            let financeStatus = ticket.status_timeline.find(a => a.level === 'Finance');

            //created status card
            let statusCard = `<div class="card border-success mb-3">
                            <div class="card-body">
                                <h5 class="card-title text-success"><i class="fas fa-check-circle"></i> Created</h5>
                                <p class="card-text">Created On <br> ${ticket.created_on}</p>
                                 
                            </div>
                            <div class="card-footer bg-transparent border-success"><b>Created</b></div>
                            </div>`;

            //manger review status card
            statusCard += `<div class="card border-success mb-3">
                            <div class="card-body ">
                                <h5 class="card-title"><i class="fas ${managerStatus?.status?(managerStatus.status === 'Approved' ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'):'fa-pause-circle'}"></i> Manger Review</h5>
                                <p class="card-text">${managerStatus?.date ?managerStatus.status+' On <br>' + managerStatus.date : ''}</p>
                                <p class="card-text"><small>${managerStatus?.reason ? 'Reason: ' + managerStatus.reason : ''}</small></p>
                            </div>
                            <div class="card-footer bg-transparent text-center"><b>${financeStatus?.status ? financeStatus.status : 'Not started'}</b></div>
                            </div>`;

            //Finance review status card
            statusCard += `<div class="card border-success mb-3">
                            <div class="card-body ">
                                <h5 class="card-title"><i class="fas ${financeStatus?.status?(financeStatus.status === 'Approved' ? ' fa-check-circle text-success' : 'fa-times-circle text-danger'):'fa-pause-circle'}"></i> Finance Review</h5>
                                <p class="card-text">${financeStatus?.date ?financeStatus.status+' On <br>' + financeStatus.date : ''}</p>
                                <p class="card-text"><small>${managerStatus?.status=='Rejected' ? 'Blocked due to rejection' : ''}</small></p>
                                <p class="card-text"><small>${financeStatus?.reason ? 'Reason: ' + financeStatus.reason : ''}</small></p>
                            </div>
                            <div class="card-footer bg-transparent text-center"><b>${financeStatus?.status ? financeStatus.status : 'Not started'}</b></div>
                            </div>`;

            //Completed status card
            statusCard += `<div class="card mb-3">
                            <div class="card-body ">
                                <h5 class="card-title"><i class="fas ${ticket.status_timeline.length > 0 ? (ticket.status=='Approved' ? 'fa-check-circle text-success' : 'fa-times-circle text-danger')  : 'fa-pause-circle'}"></i> Completed</h5>
                                <p class="card-text"><small>${ticket.status=='Rejected' ? 'Blocked due to rejection' : ''}</small></p>
                            </div>
                            <div class="card-footer bg-transparent text-center"><b>${ticket.status_timeline.length >1 ? (ticket.status=='Approved'?'Completed':'Blocked')  : 'Not started'}</b></div>
                            </div>`;


            let modalBody = `<div class="card-group">
                                ${statusCard}
                             </div>`;
            $("#ticketStatusViewModal .modal-body").html(modalBody);
            $("#ticketStatusViewModal").modal('show');

        }

        /**
         * Create action with form validation
         */
        $("#frmCreateTicket").validate({

            errorClass: 'invalid-feedback',
            errorElement: 'div',
            highlight: function (element) {
                $(element).addClass('is-invalid');
            },
            unhighlight: function (element) {
                $(element).removeClass('is-invalid');
            },

            rules: {
                title: {
                    required: true,
                    minlength: 5
                },
                amount: {
                    required: true,
                    number: true,
                    min: 1
                }
            },
            messages: {
                title: {
                    required: "Please enter title",
                    minlength: "Title must be at least 3 characters",
                    maxlength: "Title cannot exceed 100 characters"
                },
                amount: {
                    required: "Please enter amount",
                    number: "Amount must be a valid number",
                    min: "Amount cannot be less than 1"
                }
            },
            submitHandler: function (form) {

                Swal.fire({
                    title: 'Success!',
                    text: 'Ticket created successfully.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = 'create_ticket.html';
                    }
                });

            }
        });

    </script>
</body>