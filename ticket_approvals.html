<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Create Ticket | Ticket Management Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="assets/adminlte/plugins/fontawesome-free/css/all.min.css" />
    <link rel="stylesheet" href="assets/adminlte/plugins/icheck-bootstrap/icheck-bootstrap.min.css" />
    <link rel="stylesheet" href="assets/adminlte/css/adminlte.min.css" />
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="assets/adminlte/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css">

</head>


<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">

        <!-- header section start -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <div class="nav-link">Logged in as Demo User</div>
                </li>
                <li class="nav-item">
                    <button type="button" class="btn btn-sm btn-danger"
                        onclick="window.location.href='index.html'">Logout</button>
                </li>
            </ul>
        </nav>
        <!-- header section end -->

        <!-- menu section start -->
        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <a href="dashboard.html " class="brand-link text-center">
                <i class="fas fa-user fa-2x"></i>
                <span class="brand-text font-weight-light">Demo User</span>
            </a>

            <div class="sidebar">
                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" role="menu">
                        <li class="nav-item">
                            <a href="dashboard.html" class="nav-link">
                                <i class="nav-icon fas fa-tachometer-alt"></i>
                                <p>Dashboard</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="create_ticket.html" class="nav-link">
                                <i class="nav-icon fas fa-clipboard-list"></i>
                                <p>Create Ticket</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="ticket_approvals.html" class="nav-link">
                                <i class="nav-icon fas fa-calendar-alt"></i>
                                <p>Ticket Approvals</p>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>
        <!-- menu section end -->

        <div class="content-wrapper">
            <section class="content pt-3 px-3">

                <div class="container">
                    <h2>All Tickets</h2>

                    <!-- listing all tickets in a table -->
                    <table class="table table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>

                </div>

            </section>
        </div>

        <!-- modal for ticket status journey view start -->
        <div class="modal fade" id="ticketStatusViewModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-md" role="document">
                <div class="modal-content">

                    <div class="modal-header">
                        <h5 class="modal-title">Ticket View</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>

                    <div class="modal-body">
                    </div>
                </div>
            </div>
        </div>
        <!-- modal for ticket status journey view end -->

        <footer class="main-footer text-center">
            <strong>Ticket Management System</strong> &copy; 2026
        </footer>
    </div>

    <!-- Scripts -->
    <script src="assets/adminlte/plugins/jquery/jquery.min.js"></script>
    <script src="assets/adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/adminlte/js/adminlte.min.js"></script>

    <!-- validation -->
    <script src="assets/adminlte/plugins/jquery-validation/jquery.validate.min.js"></script>
    <script src="assets/adminlte/plugins/jquery-validation/additional-methods.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="assets/adminlte/plugins/sweetalert2/sweetalert2.min.js"></script>

    <!-- sample data script -->
    <script src="demo-data/tickets.js"></script>

    <script>

        /*
        * When document is ready
        */
        $(document).ready(function () {

            //call the data listing function
            getAllTickets();
        });

        //function to get all tickets
        function getAllTickets() {

            let tbody = $("table tbody");
            tbody.empty();

            //list only pending tickets for approval
            //let pendingTickets = tickets.filter(ticket => ticket.status === 'Pending');
            tickets.forEach(ticket => {

                let displayStatus = ticket.status == 'Pending' ? ticket.status + '<br><small>' + ticket.level + '</small>' : ticket.status;
                let row = `<tr>
                    <td>${ticket.id}</td>
                    <td>${ticket.title}</td>
                    <td>${ticket.amount}</td>
                    <td><span class="badge badge-${ticket.status === 'Approved' ? 'success' : ticket.status === 'Rejected' ? 'danger' : 'warning'}">${displayStatus}</span></td> // status badge with color
                    <td>
                        <button class="btn btn-info btn-sm" onclick="getStatusJourney(${ticket.id})">View</button>
                    </td>
                </tr>`;
                tbody.append(row);
            });
        }

        //tiket view for approve/reject
        function getStatusJourney(ticket_id) {

            let ticket = tickets.find(t => t.id === ticket_id);

            let actionForm = '';
            if(ticket.status =='Pending' || ticket.status_timeline.length <=1) {
                //show action form for pending tickets
                actionForm = `<div class="btn-group btn-group-toggle" data-toggle="buttons">
                                            <label class="btn btn-success">
                                                <input type="radio" name="approvalStatus" value="Approved" autocomplete="off">
                                                Approve Ticket
                                            </label>

                                            <label class="btn btn-danger">
                                                <input type="radio" name="approvalStatus" value="Rejected" autocomplete="off">
                                                Reject Ticket
                                            </label>
                                        </div>

                                        <textarea class="form-control mt-3" rows="3" placeholder="Enter remarks..."></textarea>

                                        <div class="mt-3 text-center">
                                            <input type='button' value='Submit' class='btn btn-primary' onclick='submitApproval(${ticket.id})'>
                                        </div>`;
            }
            let modalBody = `<div class="row">
                                <div class="col-sm-6 col-md-12">
                                    <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <b>Ticket #${ticket.id} - ${ticket.title}</b>
                                        </h5>
                                        <p class="card-text">Amount : ${ticket.amount} | Status: ${ticket.status} - ${ticket.level}</p>
                                        ${actionForm}
                                    </div>
                                </div> 
                            `;

            //generate journey view
            modalBody += `<div class="row">
                        <div class="col-sm-6 col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <b>Journey View</b>
                                    </h5>${journeyView(ticket)}
                                    </div>
                        </div>
                    </div>`;
                             
            $("#ticketStatusViewModal .modal-body").html(modalBody);
            $("#ticketStatusViewModal").modal('show');

        }


        //function to generate journey view
        function journeyView(ticket) {

           return ` <div class="row mt-4" id="journeyViewSection">
                        
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check-circle text-success"></i> Created On ${ticket.created_on}</li>
                        ${ticket.status_timeline.map(status => {
                            return `<li><i class="fas fa-check-circle ${status.status === 'Approved' ? 'text-success' : 'text-danger'}"></i> ${status.status} by ${status.level} on ${status.date}
                                    <br><small>${status.reason!='' ? 'Reason: ' + status.reason     : ''}</small>
                                    </li>`;
                        }).join('')}
                        </ul>
                    </div> `;
        }


        function submitApproval(ticket_id) {
            
            //get selected status
            let selectedStatus = $("input[name='approvalStatus']:checked").val();
            let remarks = $("textarea").val();

            if (!selectedStatus) {
                alert("Please select approval status.");
                return;
            }

            if (remarks.trim() === '' && selectedStatus === 'Rejected') {
                alert("Please enter remarks for rejection.");
                return;
            }

            //find the ticket and update status
            let ticket = tickets.find(t => t.id === ticket_id);
            ticket.status = selectedStatus;

            //add to timeline
            let today = new Date().toISOString().split('T')[0];
            ticket.status_timeline.push({
                status: selectedStatus,
                level: selectedStatus == 'Approved' ? 'Manager' : 'Manager',
                date: today,
                reason: remarks
            });
            alert('success')

           //generate journey view
            $("#journeyViewSection").html(journeyView(ticket));
                             
                             
        }

    </script>
</body>